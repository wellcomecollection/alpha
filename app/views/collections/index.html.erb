<% content_for :title, "Collections" %>

<h1>Collections</h1>

<%= render 'collections/search', {value: ''} %>

<hr />

<% @highlighted_collections.each do |collection| %>
  <p><%= link_to collection.name, collection %></p>
<% end %>

<% @collections.each do |collection| %>
<div class="collection">
	<h3>
		<%= link_to collection.name, collection %>
	</h3>

	<% if collection.description %>
	<p><%= collection.description %></p>
	<% end %>

	<div class="row breathe">
		<div class="three columns">

			<h4 style="margin-bottom:0;"><%= number_with_delimiter(collection.records_count) %> items</h4>

			<div class="lil-vis">
			  <div class="digitised">
				<div class="percent-done" style="width: <%= (100 * collection.digitized_records_count.to_f / collection.records_count) %>%;">&nbsp;</div>
			  </div>
			  <%= percentage_with_varying_accuracy(collection.digitized_records_count.to_f / collection.records_count) %>  digitised
			</div>

		</div>
		<div class="nine columns">
			<ul>
		        <li>

        <% @types.select {|type| type['collection_id'] == collection.id }.each do |type| %>
        	<%= link_to type.name, collection_type_path(collection, type) %>
        <% end %>

				</li>

        		<li>

          <%= @subjects.select {|s| s['collection_id'] == collection.id }.collect {|subject| link_to(subject.label, collection_subject_path(collection, subject))}.join(', ').html_safe %>

        		</li>
        <% if collection.from_year && collection.to_year %>
				  <li>Spans <%= collection.from_year %> - <%= collection.to_year %></li>
        <% end %>
			</ul>
		</div>
	</div>

	<div class="row breathe">
		<div class="twelve columns">

      <% @records_ids_per_collection.select {|r| r['collection_id'] == collection.id }.each do |record_id| %>


      <% thing = @records.find {|record| record.id == record_id['record_id'] } %>
			<div class="cover-box">
			  <div class="cover">
				<%= link_to thing_path(thing), title: thing.title do %>
				  <% if thing.cover_image_url %>
					<%= image_tag thing.cover_image_url(150,300) %>
				  <% else %>
					<%= thing.title %>
				  <% end %>
				<% end %>
			  </div>
			</div>

		  <% end %>

		</div>
	</div>

  <% count = (@people_counts.detect {|c| c['collection_id'] == collection.id } || {})['count'].to_i %>

	<h4><%= link_to(pluralize_with_delimiter(count, 'person'), collection_people_path(collection)) %> <%= count == 1 ? 'is' : 'are' %> involved</h4>

<div class="row">
  <% @people.select {|person| person['collection_id'] == collection.id }.each do |person| %>


    <div class="sm-circle">
      <% if person.wikipedia_image %>
        <% style = "background-image: url('#{person.wikipedia_image}');" %>
      <% end %>
      <%= link_to person.name, person, class: 'sm-bg-link', style: style, title: pluralize_with_delimiter(person.records_count, 'thing') %>
      <%= link_to person.name, person, class: 'sm-name', title: pluralize_with_delimiter(person.records_count, 'thing') %>
    </div>

  <% end %>

	</div>

<hr />

<% end %>
